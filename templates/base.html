<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}flickora - AI Movie Discovery{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <nav class="bg-gray-800 border-b border-gray-700">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <a
            href="{% url 'movie_list' %}"
            class="text-2xl font-bold text-red-500"
          >
            ðŸŽ¬ flickora
          </a>
          <div class="flex gap-6">
            <a
              href="{% url 'movie_list' %}"
              class="hover:text-red-500 transition"
              >Movies</a
            >
            <a href="/admin/" class="hover:text-red-500 transition">Admin</a>
          </div>
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
      {% block content %}{% endblock %}
    </main>

    <button
      id="chatToggle"
      class="fixed bottom-6 right-6 w-14 h-14 bg-red-500 hover:bg-red-600 rounded-full shadow-lg flex items-center justify-center transition z-50"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
        />
      </svg>
    </button>

    <div
      id="chatWindow"
      class="fixed bottom-24 right-6 w-96 h-[600px] bg-gray-800 rounded-lg shadow-2xl hidden flex-col z-50"
    >
      <div
        class="p-4 bg-red-500 rounded-t-lg flex items-center justify-between"
      >
        <h3 class="font-bold text-lg">ðŸ¤– AI Movie Chat</h3>
        <button id="chatClose" class="hover:bg-red-600 rounded p-1">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>

      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="bg-gray-700 rounded-lg p-3 text-sm">
          <p class="text-gray-300">ðŸ‘‹ Hi! Ask me anything about movies.</p>
        </div>
      </div>

      <form id="chatForm" class="p-4 border-t border-gray-700">
        <div class="flex gap-2">
          <input
            type="text"
            id="chatInput"
            placeholder="Ask about movies..."
            class="flex-1 px-4 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
            autocomplete="off"
          />
          <button
            type="submit"
            class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition"
          >
            Send
          </button>
        </div>
      </form>
    </div>

    <footer class="bg-gray-800 border-t border-gray-700 mt-20">
      <div class="container mx-auto px-4 py-6 text-center text-gray-400">
        <p>flickora - AI-Powered Movie Discovery & Analysis</p>
      </div>
    </footer>

    <script>
      const chatToggle = document.getElementById("chatToggle");
      const chatWindow = document.getElementById("chatWindow");
      const chatClose = document.getElementById("chatClose");
      const chatForm = document.getElementById("chatForm");
      const chatInput = document.getElementById("chatInput");
      const chatMessages = document.getElementById("chatMessages");

      chatToggle.addEventListener("click", () => {
        chatWindow.classList.remove("hidden");
        chatWindow.classList.add("flex");
        chatInput.focus();
      });

      chatClose.addEventListener("click", () => {
        chatWindow.classList.add("hidden");
        chatWindow.classList.remove("flex");
      });

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const message = chatInput.value.trim();
        if (!message) return;

        addMessage(message, "user");
        chatInput.value = "";

        const movieId = window.location.pathname.includes("/movie/")
          ? window.location.pathname.split("/movie/")[1].split("/")[0]
          : null;

        try {
          const response = await fetch("/chat/message/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              movie_id: movieId ? parseInt(movieId) : null,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            addMessage(data.message, "assistant", data.sources);
          } else {
            addMessage("Sorry, something went wrong.", "assistant");
          }
        } catch (error) {
          addMessage("Error connecting to chat service.", "assistant");
        }
      });

      function addMessage(content, role, sources = []) {
        const messageDiv = document.createElement("div");
        messageDiv.className =
          role === "user"
            ? "bg-red-500 rounded-lg p-3 text-sm ml-auto max-w-[80%]"
            : "bg-gray-700 rounded-lg p-3 text-sm max-w-[80%]";

        let html = `<p class="text-gray-100">${content}</p>`;

        if (sources && sources.length > 0) {
          html +=
            '<div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-400">';
          html += '<p class="font-semibold mb-1">Sources:</p>';
          sources.forEach((source) => {
            html += `<p>â€¢ ${source.movie_title} - ${source.section_type}</p>`;
          });
          html += "</div>";
        }

        messageDiv.innerHTML = html;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    </script>
  </body>
</html>
